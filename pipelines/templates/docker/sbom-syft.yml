parameters:
  - name: imageName
    type: string
  - name: imageTag
    type: string
    default: "$(Build.BuildNumber)"
  - name: outputFormats
    type: object
    default:
      - "spdx-json"
      - "cyclonedx-json"
  - name: attachToImage
    type: boolean
    default: true
  - name: syftVersion
    type: string
    default: "latest"

steps:
  - script: |
      set -euo pipefail

      echo "##[section]Installing Syft"

      # Install Syft
      if ! command -v syft &> /dev/null; then
        curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
      fi

      syft version
    displayName: "Install Syft"

  - script: |
      set -euo pipefail

      echo "##[section]Generating SBOM for: ${{ parameters.imageName }}:${{ parameters.imageTag }}"

      # Create SBOM directory
      mkdir -p $(Build.ArtifactStagingDirectory)/sbom

      # Generate SBOM in multiple formats
      ${{ each format in parameters.outputFormats }}:
        echo "##[command]Generating SBOM in ${{ format }} format"
        
        OUTPUT_FILE="$(Build.ArtifactStagingDirectory)/sbom/sbom-${{ format }}.json"
        
        syft packages \
          ${{ parameters.imageName }}:${{ parameters.imageTag }} \
          --output ${{ format }}=$OUTPUT_FILE
        
        echo "SBOM generated: $OUTPUT_FILE"
        
        # Display summary
        if [ "${{ format }}" = "spdx-json" ]; then
          PACKAGE_COUNT=$(jq '.packages | length' $OUTPUT_FILE)
          echo "Total packages in SBOM: $PACKAGE_COUNT"
          echo "##vso[task.setvariable variable=PackageCount;isOutput=true]$PACKAGE_COUNT"
        fi
      done

      # Generate human-readable table format
      syft packages \
        ${{ parameters.imageName }}:${{ parameters.imageTag }} \
        --output table \
        > $(Build.ArtifactStagingDirectory)/sbom/sbom-table.txt

      echo "##[section]SBOM generation completed"

    displayName: "Generate SBOM with Syft"
    name: GenerateSBOM

  - script: |
      set -euo pipefail

      if [ "${{ parameters.attachToImage }}" = "True" ]; then
        echo "##[section]Attaching SBOM to image"
        
        # Install Cosign if not already installed
        if ! command -v cosign &> /dev/null; then
          COSIGN_VERSION="v2.2.2"
          wget "https://github.com/sigstore/cosign/releases/download/${COSIGN_VERSION}/cosign-linux-amd64"
          sudo mv cosign-linux-amd64 /usr/local/bin/cosign
          sudo chmod +x /usr/local/bin/cosign
        fi
        
        IMAGE_URI="${{ parameters.imageName }}:${{ parameters.imageTag }}"
        
        # Attach SBOM using Cosign
        cosign attach sbom \
          --sbom $(Build.ArtifactStagingDirectory)/sbom/sbom-spdx-json.json \
          $IMAGE_URI
        
        echo "SBOM attached to image successfully"
      fi
    displayName: "Attach SBOM to Image"
    condition: and(succeeded(), eq('${{ parameters.attachToImage }}', 'true'))

  - task: PublishPipelineArtifact@1
    displayName: "Publish SBOM Artifacts"
    inputs:
      targetPath: "$(Build.ArtifactStagingDirectory)/sbom"
      artifact: "sbom"
      publishLocation: "pipeline"

  - script: |
      # Display SBOM summary
      echo "##[section]SBOM Summary"
      cat $(Build.ArtifactStagingDirectory)/sbom/sbom-table.txt | head -n 50
    displayName: "Display SBOM Summary"
    condition: succeeded()

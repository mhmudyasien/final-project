parameters:
  - name: imageName
    type: string
  - name: imageTag
    type: string
    default: "$(Build.BuildNumber)"
  - name: ecrRegistry
    type: string
    default: "$(AWS_ACCOUNT_ID).dkr.ecr.$(AWS_REGION).amazonaws.com"
  - name: additionalTags
    type: object
    default: []
  - name: pushLatest
    type: boolean
    default: true
  - name: enableImageScanning
    type: boolean
    default: true

steps:
  - task: Docker@2
    displayName: "Login to ECR"
    inputs:
      command: login
      containerRegistry: "AWS-ECR-ServiceConnection"

  - script: |
      set -euo pipefail

      echo "##[section]Preparing to push image to ECR"

      ECR_REPO="${{ parameters.ecrRegistry }}/${{ parameters.imageName }}"
      LOCAL_IMAGE="${{ parameters.imageName }}:${{ parameters.imageTag }}"

      echo "Local image: $LOCAL_IMAGE"
      echo "ECR repository: $ECR_REPO"

      # Ensure ECR repository exists
      aws ecr describe-repositories \
        --repository-names ${{ parameters.imageName }} \
        --region $(AWS_REGION) || \
      aws ecr create-repository \
        --repository-name ${{ parameters.imageName }} \
        --region $(AWS_REGION) \
        --image-scanning-configuration scanOnPush=${{ parameters.enableImageScanning }} \
        --image-tag-mutability IMMUTABLE

      echo "ECR repository ready"

    displayName: "Ensure ECR Repository Exists"
    env:
      AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
      AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
      AWS_REGION: $(AWS_REGION)

  - script: |
      set -euo pipefail

      ECR_REPO="${{ parameters.ecrRegistry }}/${{ parameters.imageName }}"
      LOCAL_IMAGE="${{ parameters.imageName }}:${{ parameters.imageTag }}"

      echo "##[section]Tagging image for ECR"

      # Tag with build number
      PRIMARY_TAG="$ECR_REPO:${{ parameters.imageTag }}"
      docker tag $LOCAL_IMAGE $PRIMARY_TAG
      echo "Tagged: $PRIMARY_TAG"

      # Tag with commit SHA
      COMMIT_SHA=$(echo $(Build.SourceVersion) | cut -c1-7)
      COMMIT_TAG="$ECR_REPO:sha-$COMMIT_SHA"
      docker tag $LOCAL_IMAGE $COMMIT_TAG
      echo "Tagged: $COMMIT_TAG"

      # Tag with latest (if enabled)
      if [ "${{ parameters.pushLatest }}" = "True" ]; then
        LATEST_TAG="$ECR_REPO:latest"
        docker tag $LOCAL_IMAGE $LATEST_TAG
        echo "Tagged: $LATEST_TAG"
      fi

      # Additional custom tags
      ${{ each tag in parameters.additionalTags }}:
        CUSTOM_TAG="$ECR_REPO:${{ tag }}"
        docker tag $LOCAL_IMAGE $CUSTOM_TAG
        echo "Tagged: $CUSTOM_TAG"
      done

    displayName: "Tag Image for ECR"

  - script: |
      set -euo pipefail

      ECR_REPO="${{ parameters.ecrRegistry }}/${{ parameters.imageName }}"

      echo "##[section]Pushing images to ECR"

      # Push primary tag
      echo "##[command]Pushing $ECR_REPO:${{ parameters.imageTag }}"
      docker push $ECR_REPO:${{ parameters.imageTag }}

      # Push commit SHA tag
      COMMIT_SHA=$(echo $(Build.SourceVersion) | cut -c1-7)
      echo "##[command]Pushing $ECR_REPO:sha-$COMMIT_SHA"
      docker push $ECR_REPO:sha-$COMMIT_SHA

      # Push latest (if enabled)
      if [ "${{ parameters.pushLatest }}" = "True" ]; then
        echo "##[command]Pushing $ECR_REPO:latest"
        docker push $ECR_REPO:latest
      fi

      # Push additional tags
      ${{ each tag in parameters.additionalTags }}:
        echo "##[command]Pushing $ECR_REPO:${{ tag }}"
        docker push $ECR_REPO:${{ tag }}
      done

      echo "##[section]All images pushed successfully"

    displayName: "Push Images to ECR"

  - script: |
      set -euo pipefail

      ECR_REPO="${{ parameters.ecrRegistry }}/${{ parameters.imageName }}"

      # Get image digest
      IMAGE_DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' $ECR_REPO:${{ parameters.imageTag }} | cut -d'@' -f2)

      echo "##[section]Image Push Summary"
      echo "Repository: $ECR_REPO"
      echo "Tag: ${{ parameters.imageTag }}"
      echo "Digest: $IMAGE_DIGEST"
      echo "Full URI: $ECR_REPO@$IMAGE_DIGEST"

      # Set output variables
      echo "##vso[task.setvariable variable=ImageDigest;isOutput=true]$IMAGE_DIGEST"
      echo "##vso[task.setvariable variable=ImageUri;isOutput=true]$ECR_REPO:${{ parameters.imageTag }}"
      echo "##vso[task.setvariable variable=ImageUriWithDigest;isOutput=true]$ECR_REPO@$IMAGE_DIGEST"

      # Create manifest file
      mkdir -p $(Build.ArtifactStagingDirectory)/manifests
      cat > $(Build.ArtifactStagingDirectory)/manifests/image-manifest.json <<EOF
      {
        "repository": "$ECR_REPO",
        "tag": "${{ parameters.imageTag }}",
        "digest": "$IMAGE_DIGEST",
        "uri": "$ECR_REPO:${{ parameters.imageTag }}",
        "uriWithDigest": "$ECR_REPO@$IMAGE_DIGEST",
        "buildNumber": "$(Build.BuildNumber)",
        "commitSha": "$(Build.SourceVersion)",
        "buildDate": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
      }
      EOF

      echo "Manifest created at: $(Build.ArtifactStagingDirectory)/manifests/image-manifest.json"

    displayName: "Generate Image Manifest"
    name: ImageManifest

  - task: PublishPipelineArtifact@1
    displayName: "Publish Image Manifest"
    inputs:
      targetPath: "$(Build.ArtifactStagingDirectory)/manifests"
      artifact: "image-manifest"
      publishLocation: "pipeline"

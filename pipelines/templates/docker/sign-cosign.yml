parameters:
  - name: imageName
    type: string
  - name: imageTag
    type: string
    default: "$(Build.BuildNumber)"
  - name: ecrRegistry
    type: string
    default: "$(AWS_ACCOUNT_ID).dkr.ecr.$(AWS_REGION).amazonaws.com"
  - name: signingMethod
    type: string
    default: "keyless" # 'keyless' or 'keypair'
  - name: cosignKey
    type: string
    default: "" # Only needed for keypair method
  - name: rekorUrl
    type: string
    default: "https://rekor.sigstore.dev"

steps:
  - script: |
      set -euo pipefail

      echo "##[section]Installing Cosign"

      # Install Cosign
      if ! command -v cosign &> /dev/null; then
        COSIGN_VERSION="v2.2.2"
        wget "https://github.com/sigstore/cosign/releases/download/${COSIGN_VERSION}/cosign-linux-amd64"
        sudo mv cosign-linux-amd64 /usr/local/bin/cosign
        sudo chmod +x /usr/local/bin/cosign
      fi

      cosign version
    displayName: "Install Cosign"

  - task: Docker@2
    displayName: "Login to ECR"
    inputs:
      command: login
      containerRegistry: "AWS-ECR-ServiceConnection"

  - script: |
      set -euo pipefail

      IMAGE_URI="${{ parameters.ecrRegistry }}/${{ parameters.imageName }}:${{ parameters.imageTag }}"

      echo "##[section]Signing image: $IMAGE_URI"
      echo "Signing method: ${{ parameters.signingMethod }}"

      if [ "${{ parameters.signingMethod }}" = "keyless" ]; then
        echo "##[command]Using keyless signing with OIDC"
        
        # Keyless signing using Azure DevOps OIDC token
        # Azure DevOps provides OIDC token via SYSTEM_ACCESSTOKEN
        export COSIGN_EXPERIMENTAL=1
        
        # Sign the image
        cosign sign \
          --yes \
          --oidc-issuer "https://vstoken.dev.azure.com/$(System.CollectionId)" \
          --rekor-url "${{ parameters.rekorUrl }}" \
          $IMAGE_URI
        
        echo "##[section]Image signed successfully with keyless method"
        
      elif [ "${{ parameters.signingMethod }}" = "keypair" ]; then
        echo "##[command]Using key-based signing"
        
        if [ -z "${{ parameters.cosignKey }}" ]; then
          echo "##vso[task.logissue type=error]Cosign key not provided for keypair method"
          exit 1
        fi
        
        # Write key to temporary file
        echo "${{ parameters.cosignKey }}" > /tmp/cosign.key
        
        # Sign the image with key
        COSIGN_PASSWORD="" cosign sign \
          --yes \
          --key /tmp/cosign.key \
          --rekor-url "${{ parameters.rekorUrl }}" \
          $IMAGE_URI
        
        # Clean up key file
        rm -f /tmp/cosign.key
        
        echo "##[section]Image signed successfully with keypair method"
      else
        echo "##vso[task.logissue type=error]Invalid signing method: ${{ parameters.signingMethod }}"
        exit 1
      fi

    displayName: "Sign Image with Cosign"
    env:
      COSIGN_EXPERIMENTAL: 1
      SYSTEM_ACCESSTOKEN: $(System.AccessToken)

  - script: |
      set -euo pipefail

      IMAGE_URI="${{ parameters.ecrRegistry }}/${{ parameters.imageName }}:${{ parameters.imageTag }}"

      echo "##[section]Verifying signature"

      if [ "${{ parameters.signingMethod }}" = "keyless" ]; then
        export COSIGN_EXPERIMENTAL=1
        
        # Verify with OIDC issuer
        cosign verify \
          --certificate-oidc-issuer "https://vstoken.dev.azure.com/$(System.CollectionId)" \
          --rekor-url "${{ parameters.rekorUrl }}" \
          $IMAGE_URI
          
      elif [ "${{ parameters.signingMethod }}" = "keypair" ]; then
        # For keypair, you'd need the public key
        # This is a placeholder - adjust based on your key management
        echo "Keypair verification requires public key"
      fi

      echo "##[section]Signature verified successfully"

    displayName: "Verify Signature"
    env:
      COSIGN_EXPERIMENTAL: 1
    condition: succeeded()

  - script: |
      IMAGE_URI="${{ parameters.ecrRegistry }}/${{ parameters.imageName }}:${{ parameters.imageTag }}"

      # Get signature details
      cosign tree $IMAGE_URI || true

    displayName: "Display Signature Tree"
    condition: succeeded()

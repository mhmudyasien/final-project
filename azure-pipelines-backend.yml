# azure-pipelines-backend.yml
trigger:
  branches:
    include: [main, release/*]
  tags:
    include: [v*]
  paths:
    include: [backend/*]

pr:
  branches:
    include: [main]
  paths:
    include: [backend/*]

variables:
  - group: "aws-credentials"
  - name: imageRepository
    value: "$(AWS_ACCOUNT_ID).dkr.ecr.$(AWS_REGION).amazonaws.com/capstone-project-backend"

stages:
  - stage: PRChecks
    displayName: "PR Fast Checks"
    condition: eq(variables['Build.Reason'], 'PullRequest')
    jobs:
      - job: LintAndTest
        steps:
          - template: devops/templates/python-pr-checks.yml

  - stage: BuildAndPush
    displayName: "Build, Push and Sign"
    condition: ne(variables['Build.Reason'], 'PullRequest')
    jobs:
      - job: Build
        steps:
          - template: devops/templates/aws-ecr-login.yml
            parameters:
              awsServiceConnection: "aws-service-connection"

          - template: devops/templates/docker-build-push.yml
            parameters:
              imageRepository: $(imageRepository)
              dockerContext: "backend"
              dockerfilePath: "backend/Dockerfile"

          - template: devops/templates/image-signing.yml
            parameters:
              imageFullRef: "$(imageRepository):$(Build.SourceVersion)"

          - template: devops/templates/publish-image-artifact.yml
            parameters:
              artifactName: "backend-image"
              imageRef: "$(imageRepository):$(Build.SourceVersion)"
